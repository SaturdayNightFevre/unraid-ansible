---
- name: Check Runner and Set Variables
  hosts: localhost
  become: true
  gather_facts: false
  roles:
    - runner
  tasks:
    - name: Set Ansible facts from environment variables
      set_fact:
        EMAIL: "{{ lookup('env', 'EMAIL') }}"
        DUCK_DNS_TOKEN: "{{ lookup('env', 'DUCK_DNS_TOKEN') }}"
        CF_KEY: "{{ lookup('env', 'CF_KEY') }}"
        DOMAIN: "{{ lookup('env', 'DOMAIN') }}"

- name: Ensure Docker and Networks
  hosts: johnflix
  become: false
  roles:
    - common
  vars_files:
    - vars.yml

- name: Deploy Traefik
  hosts: johnflix
  become: false
  pre_tasks:
    - name: Loading environment variables
      set_fact:
        EMAIL: "{{ hostvars['localhost'].EMAIL }}"
        DUCK_DNS_TOKEN: "{{ hostvars['localhost'].DUCK_DNS_TOKEN }}"
        CF_KEY: "{{ hostvars['localhost'].CF_KEY }}"
        DOMAIN: "{{ hostvars['localhost'].DOMAIN }}"
  roles:
    - web
  vars_files:
    - vars.yml

- name: Deploy Docker Containers
  hosts: johnflix
  become: false
  gather_facts: false
  roles:
    - 4k
    - audiobooks
    - books
  vars_files:
    - vars.yml