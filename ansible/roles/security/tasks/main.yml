---
# Create authentik-proxy container
- name: Ensure Authentik proxy container is running
  community.docker.docker_container:
    image_name_mismatch: "recreate"
    pull: "always"
    name: authentik
    image: "ghcr.io/goauthentik/server:{{ AUTHENTIK_VERSION | default('2025.4') }}"
    command: server
    restart_policy: "unless-stopped"
    env:
      AUTHENTIK_REDIS__HOST: "{{ local_ip }}"  # Using your redis container name
      AUTHENTIK_POSTGRESQL__HOST: "{{ local_ip }}"  # Using your postgres container name
      AUTHENTIK_POSTGRESQL__USER: "{{ applications | selectattr('name', 'equalto', 'authentik') | map(attribute='db_user') | first }}"
      AUTHENTIK_POSTGRESQL__NAME: "{{ applications | selectattr('name', 'equalto', 'authentik') | map(attribute='db_name') | first }}"
      AUTHENTIK_POSTGRESQL__PASSWORD: "{{ applications | selectattr('name', 'equalto', 'authentik') | map(attribute='db_password') | first }}"
      AUTHENTIK_SECRET_KEY: "{{ AUTHENTIK_SECRET_KEY | default('authentiksupersecretkey') }}"
    volumes:
      - "{{ app_data_dir }}/authentik/media:/media"
      - "{{ app_data_dir }}/authentik/custom-templates:/templates"
    ports:
      - "9000:9000"
      - "9443:9443"
    networks:
      - name: web  # External network
      - name: bridge  # Internal network
    labels:
      traefik.enable: "true"
      traefik.http.routers.authentik.rule: "Host(`authentik.{{ DOMAIN }}`) || HostRegexp(`{subdomain:[A-Za-z0-9](?:[A-Za-z0-9\\-]{0,61}[A-Za-z0-9])?}.example.com`) && PathPrefix(`/outpost.goauthentik.io/`)"
      traefik.http.services.authentik.loadbalancer.server.port: "9000"
      traefik.docker.network: "web"
      traefik.http.middlewares.authentik.forwardauth.address: "http://authentik-proxy:9000/outpost.goauthentik.io/auth/traefik"
      traefik.http.middlewares.authentik.forwardauth.trustForwardHeader: "true"
      traefik.http.middlewares.authentik.forwardauth.authResponseHeaders: "X-authentik-username,X-authentik-groups,X-authentik-email,X-authentik-name,X-authentik-uid,X-authentik-jwt,X-authentik-meta-jwks,X-authentik-meta-outpost,X-authentik-meta-provider,X-authentik-meta-app,X-authentik-meta-version"
    log_driver: json-file
    log_options:
      max-file: "1"
      max-size: 10m

# Create authentik-worker container
- name: Ensure Authentik worker container is running
  community.docker.docker_container:
    image_name_mismatch: "recreate"
    pull: "always"
    name: authentik-worker
    image: "ghcr.io/goauthentik/server:{{ AUTHENTIK_VERSION | default('2025.4') }}"
    command: worker
    user: root
    restart_policy: "unless-stopped"
    env:
      AUTHENTIK_REDIS__HOST: "{{ local_ip }}"  # Using your redis container name
      AUTHENTIK_POSTGRESQL__HOST: "{{ local_ip }}"  # Using your postgres container name
      AUTHENTIK_POSTGRESQL__USER: "{{ applications | selectattr('name', 'equalto', 'authentik') | map(attribute='db_user') | first }}"
      AUTHENTIK_POSTGRESQL__NAME: "{{ applications | selectattr('name', 'equalto', 'authentik') | map(attribute='db_name') | first }}"
      AUTHENTIK_POSTGRESQL__PASSWORD: "{{ applications | selectattr('name', 'equalto', 'authentik') | map(attribute='db_password') | first }}"
      AUTHENTIK_SECRET_KEY: "{{ AUTHENTIK_SECRET_KEY | default('authentiksupersecretkey') }}"
    volumes:
      - "{{ app_data_dir }}/authentik/certs:/certs"
      - "{{ app_data_dir }}/authentik/media:/media"
      - "{{ app_data_dir }}/authentik/custom-templates:/templates"
    networks:
      - name: web  # External network
      - name: bridge
    log_driver: json-file
    log_options:
      max-file: "1"
      max-size: 10m